<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <title>Today</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="today-icon-v9-192.png" />
  <link rel="apple-touch-icon" href="apple-touch-icon-v9.png" />

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0c1222;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.62);
      --btn:#ffffff;
      --btnText:#0b1220;

      --washA: rgba(110, 220, 255, .12); /* adƒ± yok */
      --washB: rgba(120, 255, 180, .12); /* net */
      --washC: rgba(255, 190, 90,  .14); /* zordu */

      --rBlack:#101626; /* ‚ö´ (etikette siyah yazmayacaƒüƒ±z) */
      --rBlue:#2f6bff;
      --rRed:#ff3b30;
      --rGreen:#34c759;
      --rYellow:#ffcc00;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 24px;
    }

    /* Tema: A√ßƒ±k */
    html[data-theme="light"]{
      --bg0:#f5f6f8;
      --bg1:#f3f4f7;
      --card:rgba(0,0,0,.05);
      --stroke:rgba(0,0,0,.08);
      --text:#0b1220;
      --muted:rgba(11,18,32,.58);
      --btn:#0b1220;
      --btnText:#ffffff;
      --shadow: 0 18px 50px rgba(0,0,0,.10);

      --washA: rgba( 30, 120, 255, .10);
      --washB: rgba(  0, 160,  80, .10);
      --washC: rgba(255, 140,   0, .12);
      --rBlack:#0b1220;
    }

    /* Tema: Koyu */
    html[data-theme="dark"]{
      --bg0:#070b14;
      --bg1:#070b14;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.62);
      --btn:#ffffff;
      --btnText:#0b1220;
    }

    /* Tema: Kontrast */
    html[data-theme="contrast"]{
      --bg0:#000000;
      --bg1:#000000;
      --card:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.22);
      --text:#ffffff;
      --muted:rgba(255,255,255,.75);
      --btn:#ffffff;
      --btnText:#000000;
      --shadow: 0 18px 50px rgba(0,0,0,.60);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 50% 20%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(900px 700px at 10% 90%, rgba(120,170,255,.10), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color: transparent;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .screen{
      width:min(420px, 92vw);
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .inner{ padding:26px; }

    .title{
      font-size:34px;
      letter-spacing: .14em;
      text-align:center;
      margin:8px 0 6px;
      font-weight:750;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      font-size:15px;
      margin:0 0 18px;
      line-height:1.35;
    }

    .btn{
      width:100%;
      border:0;
      padding:16px 18px;
      border-radius: 18px;
      background: var(--btn);
      color: var(--btnText);
      font-weight:700;
      font-size:18px;
      cursor:pointer;
    }
    .btn:active{ transform: scale(.99); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      color:var(--muted);
      font-size:13px;
    }

    .q{
      font-size:18px;
      text-align:center;
      margin:10px 0 18px;
      color: var(--text);
      font-weight:650;
    }

    .choices{ display:flex; flex-direction:column; gap:10px; }

    .choice{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 14px;
      background: rgba(0,0,0,.06);
      cursor:pointer;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    html[data-theme="light"] .choice{ background: rgba(255,255,255,.55); }
    html[data-theme="contrast"] .choice{ background: rgba(255,255,255,.04); }

    .radio{
      width:18px; height:18px; border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      margin-top:2px;
      flex:0 0 auto;
    }
    html[data-theme="light"] .radio{ border-color: rgba(0,0,0,.28); }
    html[data-theme="contrast"] .radio{ border-color: rgba(255,255,255,.60); }

    .choice.selected .radio{
      background: var(--text);
      border-color: var(--text);
    }
    html[data-theme="light"] .choice.selected .radio{
      background: var(--text);
      border-color: var(--text);
    }

    .ctitle{ font-weight:750; }
    .cdesc{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.3; }

    .colorRow{
      display:flex;
      gap:12px;
      justify-content:center;
      margin:16px 0 14px;
    }
    .cbtn{
      width:38px; height:38px; border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      position:relative;
    }
    html[data-theme="light"] .cbtn{ background: rgba(255,255,255,.8); }

    .dot{
      width:18px; height:18px; border-radius:50%;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
    }
    .cbtn.selected::after{
      content:"";
      position:absolute;
      inset:-3px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.75);
      pointer-events:none;
    }
    html[data-theme="light"] .cbtn.selected::after{ border-color: rgba(0,0,0,.35); }

    .noteWrap{ margin-top:10px; }
    textarea{
      width:100%;
      min-height: 92px;
      resize: vertical;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.06);
      color: var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    html[data-theme="light"] textarea{ background: rgba(255,255,255,.65); }
    html[data-theme="contrast"] textarea{ background: rgba(255,255,255,.04); }

    .row2{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }

    .linkBtn{
      border:1px solid var(--stroke);
      background: transparent;
      color: var(--text);
      border-radius: 14px;
      padding:12px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .linkBtn:active{ transform: scale(.99); }

    .mini{
      color:var(--muted);
      font-size:12px;
    }

    /* Takvim */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .monthTitle{
      font-weight:800;
      letter-spacing:.02em;
      font-size:18px;
    }

    .iconBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    html[data-theme="light"] .iconBtn{ background: rgba(255,255,255,.8); }
    .iconBtn:active{ transform: scale(.99); }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-top:10px;
    }

    .dow{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      padding:6px 0 2px;
      user-select:none;
    }

    .day{
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      position:relative;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:8px;
      user-select:none;
      overflow:hidden;
    }
    html[data-theme="light"] .day{ background: rgba(255,255,255,.75); }
    .day.inactive{
      opacity:.35;
      cursor:default;
    }

    .dnum{ font-weight:800; font-size:13px; }

    .todayRing{
      outline: 2px solid rgba(255,255,255,.55);
      outline-offset: 1px;
    }
    html[data-theme="light"] .todayRing{ outline-color: rgba(0,0,0,.22); }

    .mark{
      position:absolute;
      right:8px; bottom:8px;
      width:10px; height:10px;
      border-radius:50%;
      opacity:.9;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .pen{
      position:absolute;
      left:8px; bottom:8px;
      font-size:12px;
      opacity:.75;
    }

    .expand{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius: 18px;
      overflow:hidden;
    }
    .expandHead{
      width:100%;
      border:0;
      background: transparent;
      color:var(--text);
      padding:14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:800;
      cursor:pointer;
    }
    .expandBody{
      padding:0 14px 14px;
      color:var(--muted);
      display:none;
      font-size:13px;
      line-height:1.45;
    }
    .expand.open .expandBody{ display:block; }

    /* ƒ∞statistik paneli */
    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:10px;
    }
    .tab{
      width:40px; height:36px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
    }
    html[data-theme="light"] .tab{ background: rgba(255,255,255,.8); }
    .tab.active{
      background: var(--btn);
      color: var(--btnText);
      border-color: transparent;
    }

    .chartWrap{
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding:14px;
      margin-top:12px;
      background: rgba(255,255,255,.03);
    }
    html[data-theme="light"] .chartWrap{ background: rgba(255,255,255,.65); }

    .chart{
      height:160px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:6px;
    }
    .bar{
      flex:1 1 0;
      border-radius: 10px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      height:8%;
      transform-origin: bottom;
      animation: up .35s ease-out;
    }
    html[data-theme="light"] .bar{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.06);
    }
    @keyframes up{
      from{ transform: scaleY(.35); opacity:.6; }
      to  { transform: scaleY(1); opacity:1; }
    }

    .xlabels{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-size:12px;
    }

    /* Bottom sheet */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-100%;
      transition: transform .25s ease;
      transform: translateY(100%);
      display:flex;
      justify-content:center;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      pointer-events:none;
    }
    .sheet.show{
      transform: translateY(0);
      pointer-events:auto;
    }
    .sheetCard{
      width:min(520px, 96vw);
      background: rgba(20,28,45,.96);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    html[data-theme="light"] .sheetCard{
      background: rgba(255,255,255,.97);
      border-color: rgba(0,0,0,.10);
    }
    html[data-theme="contrast"] .sheetCard{
      background: rgba(0,0,0,.96);
      border-color: rgba(255,255,255,.22);
    }

    .handle{
      width:44px; height:5px;
      border-radius:999px;
      background: rgba(255,255,255,.25);
      margin:0 auto 12px;
    }
    html[data-theme="light"] .handle{ background: rgba(0,0,0,.14); }

    .sheetTitle{ font-weight:900; margin:2px 0 8px; text-align:center; }
    .kv{ display:flex; justify-content:space-between; gap:10px; margin:10px 0; color:var(--muted); font-size:13px;}
    .kv b{ color:var(--text); }

    .danger{
      width:100%;
      border:1px solid rgba(255,80,80,.35);
      background: rgba(255,80,80,.10);
      color: var(--text);
      padding:12px 12px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
      margin-top:10px;
    }

    /* Ekranlar */
    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .status{
      text-align:center;
      margin-top:10px;
      font-size:13px;
      color: var(--muted);
      min-height: 18px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="screen">

      <!-- VIEW: HOME -->
      <div class="inner" data-view="home">
        <div class="title">TODAY</div>
        <div class="sub">verileriniz sadece bu cihazda kaydedilmektedir.</div>
        <button class="btn" id="btnStart">Ba≈üla</button>
        <div class="status" id="statusHome"></div>
      </div>

      <!-- VIEW: PICK -->
      <div class="inner" data-view="pick">
        <div class="pill" id="todayPill">‚Äî</div>
        <div class="q">Bug√ºn sende ne oldu?</div>

        <div class="choices" id="choices">
          <div class="choice" data-choice="A">
            <div class="radio"></div>
            <div>
              <div class="ctitle">Bir ≈üey oldu ama adƒ± yok</div>
              <div class="cdesc">Adƒ±nƒ± koyma. Sadece fark et.</div>
            </div>
          </div>

          <div class="choice" data-choice="B">
            <div class="radio"></div>
            <div>
              <div class="ctitle">Her ≈üey √ßok net</div>
              <div class="cdesc">Bir c√ºmleyle s√∂yleyebiliyorsan tamam.</div>
            </div>
          </div>

          <div class="choice" data-choice="C">
            <div class="radio"></div>
            <div>
              <div class="ctitle">Zordu bug√ºn</div>
              <div class="cdesc">zorluklar olgunla≈üma i√ßin gereklidir</div>
            </div>
          </div>
        </div>

        <div class="colorRow" aria-label="Renk se√ßimi (opsiyonel)">
          <button class="cbtn" data-color="K" title="Renk 1"><span class="dot" style="background:var(--rBlack)"></span></button>
          <button class="cbtn" data-color="B" title="Renk 2"><span class="dot" style="background:var(--rBlue)"></span></button>
          <button class="cbtn" data-color="R" title="Renk 3"><span class="dot" style="background:var(--rRed)"></span></button>
          <button class="cbtn" data-color="G" title="Renk 4"><span class="dot" style="background:var(--rGreen)"></span></button>
          <button class="cbtn" data-color="Y" title="Renk 5"><span class="dot" style="background:var(--rYellow)"></span></button>
        </div>

        <div class="noteWrap">
          <textarea id="note" placeholder="Not (opsiyonel)‚Ä¶"></textarea>
          <div class="mini" id="noteHint">Not otomatik kaydedilir.</div>
        </div>

        <div class="row2">
          <button class="linkBtn" id="btnToCalendar">‚Üí Takvim</button>
          <div class="status" id="statusPick"></div>
        </div>
      </div>

      <!-- VIEW: CALENDAR -->
      <div class="inner" data-view="cal">
        <div class="topbar">
          <div>
            <div class="monthTitle" id="monthTitle">‚Äî</div>
            <div class="mini" id="monthMini">Bu ayƒ±n kayƒ±tlarƒ±</div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="iconBtn" id="btnStats" title="ƒ∞statistik">üìà</button>
            <button class="iconBtn" id="btnSettings" title="Ayarlar">‚öô</button>
          </div>
        </div>

        <div class="grid" id="dowRow"></div>
        <div class="grid" id="calGrid"></div>

        <div class="expand" id="summaryBox">
          <button class="expandHead" id="summaryToggle">
            <span>üìä Bu Ayƒ±n √ñzeti</span>
            <span id="summaryChevron">‚ñæ</span>
          </button>
          <div class="expandBody" id="summaryBody">‚Äî</div>
        </div>

        <div class="row2">
          <button class="linkBtn" id="btnBackPick">‚Üê Se√ßim</button>
          <div class="status" id="statusCal"></div>
        </div>
      </div>

      <!-- VIEW: STATS -->
      <div class="inner" data-view="stats">
        <div class="topbar">
          <div class="monthTitle">üìà ƒ∞statistik</div>
          <button class="iconBtn" id="btnCloseStats" title="Kapat">‚úï</button>
        </div>

        <div class="chartWrap">
          <div class="mini" id="statsTitle">G√ºnl√ºk overlay (00:00‚Äì23:59)</div>
          <div class="chart" id="chart"></div>
          <div class="xlabels"><span>00:00</span><span>23:59</span></div>

          <div class="tabs" aria-label="G√∂r√ºn√ºm">
            <button class="tab active" data-mode="hour" title="Saat">üïí</button>
            <button class="tab" data-mode="day" title="G√ºn">üìÖ</button>
            <button class="tab" data-mode="week" title="Hafta">üìä</button>
            <button class="tab" data-mode="month" title="Ay">üóì</button>
          </div>
        </div>

        <div class="expand" style="margin-top:12px;">
          <button class="expandHead" id="statsMoreToggle">
            <span>Detaylar</span>
            <span id="statsMoreChevron">‚ñæ</span>
          </button>
          <div class="expandBody" id="statsBody">‚Äî</div>
        </div>

        <div class="row2">
          <button class="linkBtn" id="btnExport">üì¶ CSV indir</button>
          <button class="linkBtn" id="btnBackCalFromStats">‚Üê Takvim</button>
        </div>
      </div>

      <!-- VIEW: SETTINGS -->
      <div class="inner" data-view="settings">
        <div class="topbar">
          <div class="monthTitle">‚öô Ayarlar</div>
          <button class="iconBtn" id="btnCloseSettings" title="Kapat">‚úï</button>
        </div>

        <div class="mini" style="margin:4px 0 10px;">Tema se√ßimi:</div>

        <div class="choices" id="themeChoices">
          <div class="choice" data-theme="default">
            <div class="radio"></div>
            <div><div class="ctitle">Varsayƒ±lan</div><div class="cdesc">Sakin, koyu mavi.</div></div>
          </div>
          <div class="choice" data-theme="light">
            <div class="radio"></div>
            <div><div class="ctitle">A√ßƒ±k</div><div class="cdesc">Beyaz ve ferah.</div></div>
          </div>
          <div class="choice" data-theme="dark">
            <div class="radio"></div>
            <div><div class="ctitle">Koyu</div><div class="cdesc">Daha karanlƒ±k arka plan.</div></div>
          </div>
          <div class="choice" data-theme="contrast">
            <div class="radio"></div>
            <div><div class="ctitle">Kontrastlƒ±</div><div class="cdesc">Daha belirgin ayrƒ±mlar.</div></div>
          </div>
        </div>

        <div class="row2" style="margin-top:16px;">
          <button class="linkBtn" id="btnBackCalFromSettings">‚Üê Takvim</button>
          <div class="status" id="statusSettings"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bottom sheet -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetCard">
      <div class="handle"></div>
      <div class="sheetTitle" id="sheetTitle">‚Äî</div>

      <div class="kv"><span>Se√ßim</span><b id="sheetChoice">‚Äî</b></div>
      <div class="kv"><span>Renk</span><b id="sheetColor">‚Äî</b></div>
      <div class="kv"><span>Not</span><b id="sheetNote">‚Äî</b></div>
      <div class="kv"><span>Deƒüi≈üiklik</span><b id="sheetEdits">‚Äî</b></div>

      <button class="danger" id="btnDeleteToday">Bug√ºn√º Sil</button>
    </div>
  </div>

<script>
(() => {
  // -------------------------
  // Helpers
  // -------------------------
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const pad2 = n => String(n).padStart(2,'0');

  const todayKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const parseKey = (k) => {
    const [y,m,d] = k.split('-').map(Number);
    return new Date(y, m-1, d);
  };

  const monthKeyNow = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  };

  const prettyDateTR = (k) => {
    const d = parseKey(k);
    const opts = { day:'2-digit', month:'long', year:'numeric' };
    return d.toLocaleDateString('tr-TR', opts);
  };

  // -------------------------
  // Storage model (v2)
  // data = {
  //   v:2,
  //   days: {
  //     "YYYY-MM-DD": { choice:"A|B|C", color:"K|B|R|G|Y|", note:"", edits: number, log: [{t, a}] }
  //   }
  //   theme: "default|light|dark|contrast"
  // }
  // -------------------------
  const LS_KEY = "today_data_v2";
  const load = () => {
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { v:2, days:{}, theme:"default" };
      const d = JSON.parse(raw);
      if(!d || typeof d !== "object") return { v:2, days:{}, theme:"default" };
      if(!d.days) d.days = {};
      if(!d.theme) d.theme = "default";
      d.v = 2;
      return d;
    }catch{
      return { v:2, days:{}, theme:"default" };
    }
  };
  const save = (data) => localStorage.setItem(LS_KEY, JSON.stringify(data));

  let data = load();

  // -------------------------
  // Service Worker
  // -------------------------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  // -------------------------
  // Views
  // -------------------------
  const showView = (name) => {
    $$("[data-view]").forEach(v => v.classList.remove("show"));
    $(`[data-view="${name}"]`).classList.add("show");
  };

  // Start on Home always (simple)
  showView("home");

  // -------------------------
  // Theme
  // -------------------------
  const applyTheme = (t) => {
    if(!t) t="default";
    if(t === "default") document.documentElement.removeAttribute("data-theme");
    else document.documentElement.setAttribute("data-theme", t);
    data.theme = t;
    save(data);
    paintChart(); // adapt instantly
    paintCalendar();
  };

  applyTheme(data.theme);

  // -------------------------
  // Home
  // -------------------------
  $("#btnStart").addEventListener("click", () => {
    // pick view
    preparePick();
    showView("pick");
  });

  // -------------------------
  // Pick
  // -------------------------
  const choiceEls = $$(".choice", $("#choices"));
  const colorBtns = $$(".cbtn");
  let currentDay = todayKey();

  const isToday = (k) => k === todayKey();

  const dayObj = (k) => data.days[k] || (data.days[k] = { choice:"", color:"", note:"", edits:0, log:[] });

  const bumpEdit = (k, action) => {
    const o = dayObj(k);
    o.edits = (o.edits||0) + 1;
    // log only for today (kept until day ends conceptually)
    const now = new Date();
    if(isToday(k)){
      o.log = o.log || [];
      o.log.push({ t: now.toISOString(), a: action });
    }
  };

  const setWash = (choice) => {
    const root = document.body;
    root.style.background =
      choice === "A" ? `radial-gradient(1200px 800px at 50% 20%, var(--washA), transparent 55%), radial-gradient(900px 700px at 10% 90%, rgba(120,170,255,.10), transparent 55%), linear-gradient(180deg,var(--bg0),var(--bg1))` :
      choice === "B" ? `radial-gradient(1200px 800px at 50% 20%, var(--washB), transparent 55%), radial-gradient(900px 700px at 10% 90%, rgba(120,170,255,.10), transparent 55%), linear-gradient(180deg,var(--bg0),var(--bg1))` :
      choice === "C" ? `radial-gradient(1200px 800px at 50% 20%, var(--washC), transparent 55%), radial-gradient(900px 700px at 10% 90%, rgba(120,170,255,.10), transparent 55%), linear-gradient(180deg,var(--bg0),var(--bg1))` :
      "";
  };

  const renderPick = () => {
    const o = dayObj(currentDay);
    $("#todayPill").textContent = prettyDateTR(currentDay);

    // choices UI
    choiceEls.forEach(el => {
      el.classList.toggle("selected", el.dataset.choice === o.choice);
    });

    // colors UI
    colorBtns.forEach(b => b.classList.toggle("selected", b.dataset.color === o.color));

    // note
    $("#note").value = o.note || "";

    // wash
    setWash(o.choice);
  };

  const preparePick = () => {
    currentDay = todayKey();
    // ensure object
    dayObj(currentDay);
    renderPick();
  };

  // choice click
  choiceEls.forEach(el => {
    el.addEventListener("click", () => {
      const o = dayObj(currentDay);

      // allow change only today (and only today is accessible in pick view)
      const next = el.dataset.choice;
      if(o.choice !== next){
        bumpEdit(currentDay, `choice:${next}`);
        o.choice = next;
        save(data);
        renderPick();
      } else {
        // keep but still show wash
        renderPick();
      }
    });
  });

  // color click (optional)
  colorBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const o = dayObj(currentDay);
      const c = btn.dataset.color;

      if(o.color !== c){
        bumpEdit(currentDay, `color:${c}`);
        o.color = c;
        save(data);
        renderPick();
      }
    });
  });

  // note autosave (today only)
  let noteTimer = null;
  $("#note").addEventListener("input", () => {
    clearTimeout(noteTimer);
    noteTimer = setTimeout(() => {
      const o = dayObj(currentDay);
      const v = $("#note").value || "";
      if(o.note !== v){
        bumpEdit(currentDay, "note");
        o.note = v;
        save(data);
        $("#statusPick").textContent = "Kaydedildi.";
        setTimeout(()=> $("#statusPick").textContent="", 900);
      }
    }, 350);
  });

  // to calendar
  $("#btnToCalendar").addEventListener("click", () => {
    paintCalendar();
    showView("cal");
  });

  // -------------------------
  // Calendar
  // -------------------------
  const DOW = ["Pzt","Sal","√áar","Per","Cum","Cmt","Paz"];

  const getColorValue = (code) => {
    const styles = getComputedStyle(document.documentElement);
    if(code === "K") return styles.getPropertyValue("--rBlack").trim();
    if(code === "B") return styles.getPropertyValue("--rBlue").trim();
    if(code === "R") return styles.getPropertyValue("--rRed").trim();
    if(code === "G") return styles.getPropertyValue("--rGreen").trim();
    if(code === "Y") return styles.getPropertyValue("--rYellow").trim();
    return "";
  };

  const monthTitleText = () => {
    const d = new Date();
    const m = d.toLocaleDateString("tr-TR", { month:"long", year:"numeric" });
    return m.charAt(0).toUpperCase() + m.slice(1);
  };

  const daysInMonth = (y,m) => new Date(y, m+1, 0).getDate(); // m:0-based
  const firstDowMon0 = (y,m) => {
    // convert JS Sun=0..Sat=6 to Mon=0..Sun=6
    const js = new Date(y,m,1).getDay();
    return (js + 6) % 7;
  };

  const paintCalendar = () => {
    $("#monthTitle").textContent = monthTitleText();

    // DOW row
    const dowRow = $("#dowRow");
    dowRow.innerHTML = "";
    DOW.forEach(t => {
      const d = document.createElement("div");
      d.className="dow";
      d.textContent=t;
      dowRow.appendChild(d);
    });

    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();

    const first = firstDowMon0(y,m);
    const total = daysInMonth(y,m);

    const grid = $("#calGrid");
    grid.innerHTML = "";

    // fillers before 1st
    for(let i=0;i<first;i++){
      const cell = document.createElement("div");
      cell.className="day inactive";
      grid.appendChild(cell);
    }

    // days
    for(let d=1; d<=total; d++){
      const k = `${y}-${pad2(m+1)}-${pad2(d)}`;
      const cell = document.createElement("div");
      cell.className="day";
      const num = document.createElement("div");
      num.className="dnum";
      num.textContent = d;
      cell.appendChild(num);

      // today ring
      if(k === todayKey()) cell.classList.add("todayRing");

      const o = data.days[k];
      if(o && (o.choice || o.color || o.note)){
        // color mark / wash
        if(o.color){
          const mark = document.createElement("div");
          mark.className="mark";
          mark.style.background = getColorValue(o.color) || "rgba(255,255,255,.8)";
          cell.appendChild(mark);

          // wash background
          cell.style.background = `linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), radial-gradient(140px 140px at 30% 30%, ${getColorValue(o.color)}22, transparent 55%)`;
          if(document.documentElement.getAttribute("data-theme")==="light"){
            cell.style.background = `linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01)), radial-gradient(140px 140px at 30% 30%, ${getColorValue(o.color)}22, transparent 55%)`;
          }
        }
        if(o.note && o.note.trim()){
          const pen = document.createElement("div");
          pen.className="pen";
          pen.textContent="‚úé";
          cell.appendChild(pen);
        }
      }

      // lock logic: only today editable/inspectable; other days open sheet read-only
      cell.addEventListener("click", () => openDaySheet(k));
      grid.appendChild(cell);
    }

    // summary
    paintSummary();
  };

  const paintSummary = () => {
    const mk = monthKeyNow(); // YYYY-MM
    const entries = Object.entries(data.days).filter(([k,o]) => k.startsWith(mk) && o && (o.choice||o.color||o.note));

    let countA=0,countB=0,countC=0, notes=0, edited=0;
    entries.forEach(([k,o])=>{
      if(o.choice==="A") countA++;
      if(o.choice==="B") countB++;
      if(o.choice==="C") countC++;
      if(o.note && o.note.trim()) notes++;
      if((o.edits||0)>0) edited++;
    });

    const top = [
      ["Bir ≈üey oldu ama adƒ± yok", countA],
      ["Her ≈üey √ßok net", countB],
      ["Zordu bug√ºn", countC],
    ].sort((a,b)=>b[1]-a[1])[0];

    const body = $("#summaryBody");
    if(entries.length===0){
      body.textContent = "Bu ay hen√ºz kayƒ±t yok.";
      return;
    }
    body.innerHTML =
      `En √ßok se√ßilen: <b style="color:var(--text)">${top[0]}</b> (${top[1]})<br>` +
      `Not yazƒ±lan g√ºn: <b style="color:var(--text)">${notes}</b><br>` +
      `Kayƒ±t bulunan g√ºn: <b style="color:var(--text)">${entries.length}</b><br>` +
      `Deƒüi≈üiklik yapƒ±lan g√ºn: <b style="color:var(--text)">${edited}</b>`;
  };

  // summary toggle
  $("#summaryToggle").addEventListener("click", () => {
    const box = $("#summaryBox");
    box.classList.toggle("open");
    $("#summaryChevron").textContent = box.classList.contains("open") ? "‚ñ¥" : "‚ñæ";
  });

  $("#btnBackPick").addEventListener("click", () => {
    preparePick();
    showView("pick");
  });

  // -------------------------
  // Bottom sheet (day detail)
  // -------------------------
  const overlay = $("#overlay");
  const sheet = $("#sheet");
  const closeSheet = () => {
    overlay.classList.remove("show");
    sheet.classList.remove("show");
  };
  overlay.addEventListener("click", closeSheet);

  const choiceText = (c) => c==="A" ? "Bir ≈üey oldu ama adƒ± yok" : c==="B" ? "Her ≈üey √ßok net" : c==="C" ? "Zordu bug√ºn" : "‚Äî";
  const colorText = (c) => c==="K" ? "‚óè" : c==="B" ? "‚óè" : c==="R" ? "‚óè" : c==="G" ? "‚óè" : c==="Y" ? "‚óè" : "‚Äî";
  const openDaySheet = (k) => {
    const o = data.days[k] || { choice:"", color:"", note:"", edits:0, log:[] };
    $("#sheetTitle").textContent = prettyDateTR(k) + (k===todayKey() ? "" : " (Kilitli)");
    $("#sheetChoice").textContent = choiceText(o.choice);
    $("#sheetColor").textContent = colorText(o.color);
    $("#sheetColor").style.color = getColorValue(o.color) || "var(--text)";
    $("#sheetNote").textContent = (o.note && o.note.trim()) ? o.note.trim() : "‚Äî";
    $("#sheetEdits").textContent = String(o.edits || 0);

    // delete only today
    $("#btnDeleteToday").style.display = (k===todayKey()) ? "block" : "none";

    overlay.classList.add("show");
    sheet.classList.add("show");
  };

  $("#btnDeleteToday").addEventListener("click", () => {
    const k = todayKey();
    if(data.days[k]){
      data.days[k] = { choice:"", color:"", note:"", edits:0, log:[] };
      save(data);
    }
    closeSheet();
    preparePick();
    paintCalendar();
  });

  // -------------------------
  // Stats
  // -------------------------
  const statsMode = { value: "hour" };

  const paintChart = () => {
    // simple vertical bars; we fill from stored edit logs (today) and month density as a proxy
    const mode = statsMode.value;
    const chart = $("#chart");
    chart.innerHTML = "";

    // create N bars
    const N = mode==="hour" ? 24 : mode==="day" ? 30 : mode==="week" ? 12 : 12;
    const now = new Date();

    // gather activity counts
    const counts = new Array(N).fill(0);

    if(mode === "hour"){
      // today logs by hour
      const k = todayKey();
      const o = data.days[k];
      if(o && Array.isArray(o.log)){
        o.log.forEach(e=>{
          const hh = new Date(e.t).getHours();
          if(hh>=0 && hh<24) counts[hh] += 1;
        });
      }
    } else if(mode === "day"){
      // last 30 days with any activity
      for(let i=0;i<30;i++){
        const d = new Date(now);
        d.setDate(now.getDate()- (29-i));
        const kk = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        const o = data.days[kk];
        if(o && (o.choice||o.color|| (o.note && o.note.trim()) )) counts[i] = 1 + Math.min(4, (o.edits||0));
      }
    } else if(mode === "week"){
      // last 12 weeks
      for(let i=0;i<12;i++){
        const start = new Date(now);
        start.setDate(now.getDate() - ((11-i)*7));
        let sum=0;
        for(let j=0;j<7;j++){
          const d = new Date(start);
          d.setDate(start.getDate()+j);
          const kk = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          const o = data.days[kk];
          if(o && (o.choice||o.color||(o.note && o.note.trim()))) sum += 1 + Math.min(4,(o.edits||0));
        }
        counts[i] = sum;
      }
    } else {
      // last 12 months
      const base = new Date(now.getFullYear(), now.getMonth(), 1);
      for(let i=0;i<12;i++){
        const d = new Date(base.getFullYear(), base.getMonth()-(11-i), 1);
        const prefix = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
        let sum=0;
        Object.entries(data.days).forEach(([k,o])=>{
          if(k.startsWith(prefix) && o && (o.choice||o.color||(o.note && o.note.trim()))) sum += 1 + Math.min(4,(o.edits||0));
        });
        counts[i] = sum;
      }
    }

    const max = Math.max(1, ...counts);
    // color by today's selected color (optional)
    const tcol = getColorValue((data.days[todayKey()]||{}).color);
    const barColor = tcol ? tcol : "rgba(255,255,255,.35)";

    for(let i=0;i<N;i++){
      const b = document.createElement("div");
      b.className="bar";
      const h = 8 + Math.round((counts[i]/max) * 92);
      b.style.height = `${h}%`;
      b.style.background = `linear-gradient(180deg, ${barColor}66, ${barColor}22)`;
      chart.appendChild(b);
    }

    $("#statsTitle").textContent =
      mode==="hour" ? "G√ºnl√ºk overlay (00:00‚Äì23:59)" :
      mode==="day"  ? "Son 30 g√ºn" :
      mode==="week" ? "Son 12 hafta" :
                      "Son 12 ay";

    // details body
    paintStatsBody(mode, counts);
  };

  const paintStatsBody = (mode, counts) => {
    const sum = counts.reduce((a,b)=>a+b,0);
    const nonzero = counts.filter(x=>x>0).length;
    const txt =
      `Toplam aktivite: <b style="color:var(--text)">${sum}</b><br>`+
      `Aktif dilim: <b style="color:var(--text)">${nonzero}</b><br>`+
      `Not: Aktivite, se√ßim/renk/not ve g√ºn i√ßi deƒüi≈üikliklerden t√ºretilir.`;
    $("#statsBody").innerHTML = txt;
  };

  // stats open/close
  $("#btnStats").addEventListener("click", () => {
    paintChart();
    showView("stats");
  });
  $("#btnCloseStats").addEventListener("click", () => showView("cal"));
  $("#btnBackCalFromStats").addEventListener("click", () => showView("cal"));

  // stats details toggle
  const statsMore = { open:false };
  $("#statsMoreToggle").addEventListener("click", () => {
    const box = $("#statsMoreToggle").parentElement;
    box.classList.toggle("open");
    $("#statsMoreChevron").textContent = box.classList.contains("open") ? "‚ñ¥" : "‚ñæ";
  });

  // mode tabs
  $$(".tab").forEach(t => {
    t.addEventListener("click", () => {
      $$(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      statsMode.value = t.dataset.mode;
      paintChart();
    });
  });

  // -------------------------
  // Settings
  // -------------------------
  $("#btnSettings").addEventListener("click", () => {
    // sync radio
    const t = data.theme || "default";
    $$("#themeChoices .choice").forEach(el => {
      el.classList.toggle("selected", el.dataset.theme === t);
    });
    showView("settings");
  });

  $("#btnCloseSettings").addEventListener("click", () => showView("cal"));
  $("#btnBackCalFromSettings").addEventListener("click", () => showView("cal"));

  $$("#themeChoices .choice").forEach(el => {
    el.addEventListener("click", () => {
      $$("#themeChoices .choice").forEach(x=>x.classList.remove("selected"));
      el.classList.add("selected");
      applyTheme(el.dataset.theme);
      $("#statusSettings").textContent = "Uygulandƒ±.";
      setTimeout(()=>$("#statusSettings").textContent="", 900);
    });
  });

  // -------------------------
  // Export CSV (Turkish headers)
  // -------------------------
  $("#btnExport").addEventListener("click", () => {
    const rows = [["tarih","secim","renk","not","degisiklik_sayisi"]];
    const entries = Object.entries(data.days)
      .filter(([k,o]) => o && (o.choice || o.color || (o.note && o.note.trim())))
      .sort((a,b)=> a[0].localeCompare(b[0]));

    const choiceTR = (c) => c==="A" ? "Bir ≈üey oldu ama adƒ± yok" : c==="B" ? "Her ≈üey √ßok net" : c==="C" ? "Zordu bug√ºn" : "";
    const colorTR = (c) => c==="K" ? "Renk-1" : c==="B" ? "Renk-2" : c==="R" ? "Renk-3" : c==="G" ? "Renk-4" : c==="Y" ? "Renk-5" : "";

    entries.forEach(([k,o]) => {
      rows.push([k, choiceTR(o.choice), colorTR(o.color), (o.note||"").replace(/\n/g," "), String(o.edits||0)]);
    });

    const csv = rows.map(r => r.map(v=>{
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `today-rapor-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });

  // -------------------------
  // Initial render for calendar cache
  // -------------------------
  // prebuild calendar if user goes there
  // (nothing else)
})();
</script>
</body>
</html>